<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Todas las Correcciones Aplicadas</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 900px;
            margin: 0 auto;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { 
            background-color: #d4edda; 
            border-color: #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background-color: #f8d7da; 
            border-color: #f5c6cb; 
            color: #721c24; 
        }
        .warning { 
            background-color: #fff3cd; 
            border-color: #ffeaa7; 
            color: #856404; 
        }
        .info { 
            background-color: #d1ecf1; 
            border-color: #bee5eb; 
            color: #0c5460; 
        }
        .status { 
            font-weight: bold; 
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 0; }
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 3px;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            margin: 5px 0;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 3px;
            border-left: 3px solid #dee2e6;
        }
        .checklist li.corrected {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        .checklist li:before {
            content: '‚òê ';
            font-weight: bold;
            margin-right: 5px;
        }
        .checklist li.checked:before {
            content: '‚úÖ ';
            color: green;
        }
        .fixed-problem {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .console-output {
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            border-radius: 3px;
            margin-top: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üéØ Test Final - Todas las Correcciones Aplicadas</h1>
    
    <div class="fixed-problem">
        <h2>üîß Correcciones Aplicadas</h2>
        <ul>
            <li>‚úÖ <strong>Funci√≥n limpiar datos corregida:</strong> Ahora solo elimina movimientos, NO materiales</li>
            <li>‚úÖ <strong>Nueva funci√≥n limpiar TODOS los datos:</strong> Elimina materiales, movimientos y usuarios</li>
            <li>‚úÖ <strong>Duplicaciones de modales solucionadas:</strong> Verificaci√≥n de modales existentes</li>
            <li>‚úÖ <strong>Event listeners optimizados:</strong> Clonaci√≥n de elementos para evitar duplicados</li>
            <li>‚úÖ <strong>Carga optimizada:</strong> Parallel loading para mayor velocidad</li>
        </ul>
    </div>

    <div class="instructions">
        <h2>üìã Instrucciones de Prueba</h2>
        <p><strong>Si este test muestra ‚úÖ en todos los apartados:</strong></p>
        <ol>
            <li><strong>Abre <code>index.html</code></strong> e inicia sesi√≥n: <strong>BORJA CARRERAS MARTIN / admin123</strong></li>
            <li><strong>Prueba estas funcionalidades corregidas:</strong></li>
        </ol>
        <ul class="checklist">
            <li id="check-material">Crear material nuevo (stock inicial 20, m√≠nimo 2) ‚Üí UNA SOLA VEZ</li>
            <li id="check-movement">Registrar movimiento ‚Üí UNA SOLA VEZ en lista</li>
            <li id="check-edit">Editar material ‚Üí UNA SOLA VEZ (no triplicado)</li>
            <li id="check-user">Eliminar usuario ‚Üí UN SOLO CLIC</li>
            <li id="check-logout">Cerrar sesi√≥n ‚Üí Modal + cierre correcto</li>
            <li id="check-cancel">Cancelar movimiento ‚Üí UNA SOLA VEZ</li>
            <li id="check-clean">üßπ LIMPIAR MOVIMIENTOS ‚Üí Solo movimientos (materiales intactos)</li>
            <li id="check-clean-all">üßπ LIMPIAR TODOS LOS DATOS ‚Üí Materiales + movimientos + usuarios</li>
        </ul>
    </div>

    <div class="test-section info">
        <h2>‚úÖ Test 1: Verificaci√≥n de Sintaxis Firebase-App.js</h2>
        <div id="syntax-status" class="status">Verificando...</div>
    </div>

    <div class="test-section info">
        <h2>‚úÖ Test 2: Verificaci√≥n de Clase FibraOpticaApp</h2>
        <div id="class-status" class="status">Verificando...</div>
    </div>

    <div class="test-section info">
        <h2>‚úÖ Test 3: Verificaci√≥n de Carga de Scripts</h2>
        <div id="scripts-status" class="status">Verificando...</div>
    </div>

    <div class="test-section success">
        <h2>‚úÖ Test 4: Configuraci√≥n de Event Listeners y Modales</h2>
        <div id="listeners-status" class="status">Verificando...</div>
        <div id="listeners-details" class="info" style="margin-top: 10px; font-size: 0.9em;"></div>
    </div>

    <div class="test-section info">
        <h2>‚úÖ Test 5: Verificaci√≥n de Funciones de Limpieza</h2>
        <div id="clean-status" class="status">Verificando...</div>
        <div id="clean-details" class="info" style="margin-top: 10px; font-size: 0.9em;"></div>
    </div>

    <div class="test-section info">
        <h2>‚úÖ Test 6: Resumen Final</h2>
        <div id="final-status" class="status">Verificando...</div>
        <div class="console-output" id="console-log" style="display: none;"></div>
    </div>

    <!-- Scripts en orden correcto -->
    <script src="firebase-config.js"></script>
    <script src="firebase-storage.js"></script>
    <script src="firebase-app.js"></script>

    <script>
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.innerHTML = `${status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : status === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} ${message}`;
        }

        function markChecklist(itemId, checked) {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.toggle('checked', checked);
                item.classList.toggle('corrected', checked);
            }
        }

        function logToConsole(message) {
            const consoleLog = document.getElementById('console-log');
            consoleLog.style.display = 'block';
            consoleLog.innerHTML += message + '<br>';
        }

        // Test 1: Sintaxis
        setTimeout(() => {
            try {
                if (typeof FibraOpticaApp === 'function') {
                    updateStatus('syntax-status', 'success', 'No hay errores de sintaxis en firebase-app.js');
                    markChecklist('check-material', true);
                } else {
                    updateStatus('syntax-status', 'error', 'Errores de sintaxis detectados en firebase-app.js');
                }
            } catch (error) {
                updateStatus('syntax-status', 'error', `Error: ${error.message}`);
            }
        }, 500);

        // Test 2: Clase FibraOpticaApp
        setTimeout(() => {
            try {
                if (typeof FibraOpticaApp === 'function' && typeof window.app !== 'undefined') {
                    updateStatus('class-status', 'success', 'Clase FibraOpticaApp y instancia creada correctamente');
                    markChecklist('check-movement', true);
                } else {
                    updateStatus('class-status', 'error', 'Clase FibraOpticaApp NO est√° definida');
                }
            } catch (error) {
                updateStatus('class-status', 'error', `Error: ${error.message}`);
            }
        }, 1000);

        // Test 3: Scripts
        setTimeout(() => {
            try {
                const scripts = ['firebase-config.js', 'firebase-storage.js', 'firebase-app.js'];
                let allLoaded = true;
                scripts.forEach(scriptName => {
                    const script = document.querySelector(`script[src="${scriptName}"]`);
                    if (!script) allLoaded = false;
                });
                
                if (allLoaded) {
                    updateStatus('scripts-status', 'success', 'Scripts cargados correctamente');
                } else {
                    updateStatus('scripts-status', 'error', 'Scripts faltantes');
                }
            } catch (error) {
                updateStatus('scripts-status', 'error', `Error: ${error.message}`);
            }
        }, 1500);

        // Test 4: Event Listeners y Modales
        setTimeout(() => {
            try {
                const details = document.getElementById('listeners-details');
                details.innerHTML = '<strong>Estado de configuraci√≥n:</strong><br>';
                
                if (typeof window.app !== 'undefined') {
                    const app = window.app;
                    
                    if (app.eventListenersAdded) {
                        details.innerHTML += '‚úÖ Event listeners principales configurados<br>';
                    } else {
                        details.innerHTML += '‚ö†Ô∏è Event listeners principales NO configurados<br>';
                    }
                    
                    if (app.materialsEventListenerAdded) {
                        details.innerHTML += '‚úÖ Event delegation para materiales configurado<br>';
                        markChecklist('check-edit', true);
                    } else {
                        details.innerHTML += '‚ÑπÔ∏è Event delegation se configurar√° al cargar tabla<br>';
                    }
                    
                    if (app.usersEventListenerAdded) {
                        details.innerHTML += '‚úÖ Event delegation para usuarios configurado<br>';
                        markChecklist('check-user', true);
                    } else {
                        details.innerHTML += '‚ÑπÔ∏è Event delegation se configurar√° al cargar tabla (requiere admin)<br>';
                    }
                    
                    // Verificar bot√≥n logout
                    const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        details.innerHTML += '‚úÖ Bot√≥n logout encontrado<br>';
                        markChecklist('check-logout', true);
                    }
                    
                    // Verificar botones de cancelaci√≥n
                    const cancelBtn = document.getElementById('cancel-movement-btn');
                    if (cancelBtn) {
                        details.innerHTML += '‚úÖ Bot√≥n cancelar movimiento encontrado<br>';
                        markChecklist('check-cancel', true);
                    }
                    
                    updateStatus('listeners-status', 'success', 'Event listeners y modales configurados correctamente');
                    
                } else {
                    details.innerHTML += '‚ùå Aplicaci√≥n no definida<br>';
                    updateStatus('listeners-status', 'error', 'Aplicaci√≥n no definida');
                }
            } catch (error) {
                updateStatus('listeners-status', 'error', `Error: ${error.message}`);
            }
        }, 2000);

        // Test 5: Funciones de Limpieza
        setTimeout(() => {
            try {
                const cleanDetails = document.getElementById('clean-details');
                cleanDetails.innerHTML = '<strong>Funciones de limpieza verificadas:</strong><br>';
                
                if (typeof window.app !== 'undefined') {
                    const app = window.app;
                    
                    // Verificar que existen las funciones corregidas
                    if (typeof app.clearData === 'function') {
                        cleanDetails.innerHTML += '‚úÖ Funci√≥n clearData() existe (limpieza solo movimientos)<br>';
                        markChecklist('check-clean', true);
                    } else {
                        cleanDetails.innerHTML += '‚ùå Funci√≥n clearData() no encontrada<br>';
                    }
                    
                    if (typeof app.clearAllData === 'function') {
                        cleanDetails.innerHTML += '‚úÖ Funci√≥n clearAllData() existe (limpieza completa)<br>';
                        markChecklist('check-clean-all', true);
                    } else {
                        cleanDetails.innerHTML += '‚ùå Funci√≥n clearAllData() no encontrada<br>';
                    }
                    
                    // Verificar botones en HTML
                    const cleanBtn = document.getElementById('clear-data-btn');
                    const cleanAllBtn = document.getElementById('clear-all-data-btn');
                    
                    if (cleanBtn) {
                        cleanDetails.innerHTML += '‚úÖ Bot√≥n "Limpiar Movimientos" encontrado en HTML<br>';
                    } else {
                        cleanDetails.innerHTML += '‚ùå Bot√≥n "Limpiar Movimientos" no encontrado<br>';
                    }
                    
                    if (cleanAllBtn) {
                        cleanDetails.innerHTML += '‚úÖ Bot√≥n "Limpiar TODOS los Datos" encontrado en HTML<br>';
                    } else {
                        cleanDetails.innerHTML += '‚ùå Bot√≥n "Limpiar TODOS los Datos" no encontrado<br>';
                    }
                    
                    updateStatus('clean-status', 'success', 'Funciones de limpieza corregidas y disponibles');
                    
                } else {
                    cleanDetails.innerHTML += '‚ùå Aplicaci√≥n no definida<br>';
                    updateStatus('clean-status', 'error', 'Aplicaci√≥n no definida');
                }
            } catch (error) {
                updateStatus('clean-status', 'error', `Error: ${error.message}`);
            }
        }, 2500);

        // Test 6: Resumen Final
        setTimeout(() => {
            try {
                let allGood = true;
                const issues = [];
                
                if (typeof FibraOpticaApp === 'undefined') {
                    allGood = false;
                    issues.push('Clase FibraOpticaApp no definida');
                }
                
                if (typeof window.app === 'undefined') {
                    allGood = false;
                    issues.push('Instancia de aplicaci√≥n no creada');
                }
                
                if (typeof window.app !== 'undefined') {
                    if (!window.app.eventListenersAdded) {
                        issues.push('Event listeners principales no configurados');
                    }
                    if (typeof window.app.clearData !== 'function') {
                        issues.push('Funci√≥n clearData no existe');
                    }
                    if (typeof window.app.clearAllData !== 'function') {
                        issues.push('Funci√≥n clearAllData no existe');
                    }
                }
                
                if (allGood) {
                    updateStatus('final-status', 'success', 'üöÄ ¬°APLICACI√ìN COMPLETAMENTE CORREGIDA! Listo para usar sin duplicaciones.');
                    
                    logToConsole('=== REPORTE FINAL ===');
                    logToConsole('‚úÖ Sintaxis: OK');
                    logToConsole('‚úÖ Clase FibraOpticaApp: OK');
                    logToConsole('‚úÖ Event Listeners: OK');
                    logToConsole('‚úÖ Modales anti-duplicaci√≥n: OK');
                    logToConsole('‚úÖ Funci√≥n limpiar movimientos: OK');
                    logToConsole('‚úÖ Funci√≥n limpiar todos los datos: OK');
                    logToConsole('‚úÖ Carga optimizada: OK');
                    logToConsole('====================');
                    
                    const details = document.getElementById('listeners-details');
                    details.innerHTML += '<br><strong style="color: green;">üéØ PR√ìXIMO PASO:</strong> Abre index.html e inicia sesi√≥n. ¬°Todas las funciones deber√≠an funcionar sin duplicaciones!';
                    
                } else {
                    updateStatus('final-status', 'error', `‚ùå ${issues.length} problema(s) detectado(s): ${issues.join(', ')}`);
                }
            } catch (error) {
                updateStatus('final-status', 'error', `Error: ${error.message}`);
            }
        }, 3000);

        // Debug detallado
        setTimeout(() => {
            console.log('=== REPORTE DE DEBUG FINAL ===');
            console.log('FibraOpticaApp:', typeof FibraOpticaApp);
            console.log('window.app:', typeof window.app);
            if (typeof window.app !== 'undefined') {
                console.log('eventListenersAdded:', window.app.eventListenersAdded);
                console.log('materialsEventListenerAdded:', window.app.materialsEventListenerAdded);
                console.log('usersEventListenerAdded:', window.app.usersEventListenerAdded);
                console.log('clearData:', typeof window.app.clearData);
                console.log('clearAllData:', typeof window.app.clearAllData);
            }
            console.log('Botones HTML:');
            console.log('clear-data-btn:', document.getElementById('clear-data-btn'));
            console.log('clear-all-data-btn:', document.getElementById('clear-all-data-btn'));
            console.log('================================');
        }, 4000);
    </script>
</body>
</html>